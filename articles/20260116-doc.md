=---
title: FreeBSD上のIIJ/seilx86-ayame で Interlink/IPoE/IPv4固定サービスを受けてみる
description: NTT光クロス導入先で色々やってみたことを書く
date: 2026-01-16T09:50:01.000Z
draft: false
tags:
  - FreeBSD
  - bhyve
  - seilx86
  - IPIP
categories:
  - Technology
---
# IIJ/seilx86 on FreeBSD で、IPoEサービスを設定してみた記録

## FreeBSDでのipv6 状況

FreeBSD で、Layer7 サービスを動かすのはそこそこシンプルで苦労しません。
サーバでは苦労することがほぼない鉄板ですが、こと近年のネットワークスタックになってくると
諸事情で色々できないこと発展途上な部分が多いです。

物理層では過去でもNetBSDなどからデバイスドライバが取り込まれていくことが多かったり、
最近では wifibox のような仮想化linuxでWIFIドライバを丸ごと取り込んで済ませようという流れがあり、
ネットワークの古い枠組では強固なサービス提供を約束する一方で、最新のネットワーク絡みでは周回遅れの感があります。

まあコードにコミットしてない利用者レベルでは愚痴っても仕方ないので、長いものに巻かれるしかないですね。

## 日本ならではのネットワーク事情

まあ、もう普及して10年以上経つので枯れて来ているはずの技術ですが、IPv4をIPv6を通して使うなんてのは日本だけの風習・・というか、IPv4割り当てが人口比で余っている地域とそうでない地域の差があるようです。海外ではDS-Liteを使わなくちゃならないのは後発国というイメージがあり、それぞれ既存のプラットフォームに載せようとしています。　IPv6を普及させようというのは世界的にみるとIPv4が本当に枯渇している地域とそうでないところがあるという感じが露骨にあり、そういう意味では日本はIPv6を「使わざる得ないから使う」に傾いたIPv4はそこそこ抱えているけど人口比で見ると少ない地域になります。

##  Transix のIPIP 接続

* [DS-Lite](https://e-words.jp/w/DS-Lite.html) 
とか、
* [MAP-E](https://www.allied-telesis.co.jp/support/list/awp/rel/5.4.9-2.6/613-002937_A/docs/overview-358.html) 
なんてのが日本のいわゆる広域のIPv6ネットワーク経由IPv4サービス利用に使われる技術です。
これらはRFC6333、RFC7597で提案されて書かれて広く使われています

が、これらは、「IPv4の接続を複数で共有」「ポートをマッピングして共有」というような方法です。固定されたIPv4アドレスが
望まれる場合には使えません。そこでIPv4にIPIPトンネルして使う様々な方法が開発されているようです。その一つが、

* [transix](https://www.mfeed.ad.jp/transix/overview.html) 

で、今回私はこれをを使っているISP [株式会社インターリンク](https://www.interlink.or.jp/) さんの ZOOT NATIVE(IPv4固定) サービスというのを選択してみました。

## NTT東日本フレッツ光クロスのこと

* サービス開始してから数年が経過して、人口の多い地域では普通に利用できる普及時期に入りました。10Gの回線といってもそんな広帯域を「帯域保証」されることはあり得ませんが、それでも1000Mbpsシェアするよりは10倍の効果はあるかと思います。　契約によって帯域制限はかかる可能性がありますが、今回光クロスに変更された拠点では、VDSLだったものですから比較的高速化はされています。

* 今回の記事では、私の自宅ではないため、10Gpon -> NTT東日本がレンタルするHGW (XG-10NE) が貸与される形になっています。まあ、この手のネットワーク技術猛者在住される（いわゆる逸般の誤家庭）では直接SPF＋トランシーバをL3SWにぶっさすなんてことをされることも普通になってしまったのかもしれませんが、提供先はまだGbEだったので、とりあえず自宅で転がってたIntel X550-T2 をルータ代わりにする予定のサーバに突っ込んで 10GbEを受け取るだけにしました。

* 技術的に不勉強なもので、HGWの下流でないと動かなかったのがありましたが、？？？「ひかり電話契約」してる関係かなーというくらいで深掘りはしていません（というか、10GbEスイッチがあればもう少しまともかもしれない・・）

## この記事を書くに至るまでの流れ

* 県内のとある取引先。拠点が二つあります。今回本社側にNTTフレッツの光クロスを導入することになりました。
* しかしながら、ここの本社にはさして重要なサーバがなく、支店にあるサーバのバックアップと拠点間VPNができるようになっています。これには導入時期の問題とか事務所が本社に置けなかったりする事情によるもの。
* フレッツ光NGNを5年程度使っていて、すでにNTT東日本フレッツのIPv6網内で使えるIPv6を利用「IPv6 オプション」の恩恵は受けていました。
* 二箇所の拠点間にある　FreeBSD サーバに wireguard を乗っけてIPv4のトンネルが機能しています。
* NGNの　IPv4固定サービスは、従来サービスのIPv4のPPPoE、または、PPTP/wireguard のIPトンネルサービスを利用するしかやって来ていません。この拠点の場合は、IPoE/DS-Liteを経由してPPTPを使ったIPv4固定サービスを利用していますが、ご存知の通りまともな性能など出るはずがありません。
* VPNはIPv6で張れるようになったこともあって、苦労はしていないようです。
* 支店にIPv4の固定IPサービスが入っています。僻地にあるのもあってそこそこ遅いですが、本社もVDSLだったので速度差は微妙。時間帯によってVPNが酷いことになっていました。


## ひかり電話契約だけではIPv6は使えなくなる罠

* そもそもこの話は取引先が営業電話から切り替えを進めた関係で、「まあ大丈夫でしょう」ということもあったのですが、支店が引っ越すこともあって、本社にサーバ機能を移しておきたいという将来的な観点から、「ひかり電話＋IP接続」みたいなのから、IPv4固定をやってみようと提案しました。
* インターリンクさんのサービスは、こういう時に「お試し」ができてとても便利です。PPPoEサービス全盛の時代から重宝していました。
* IPv4固定のサービスがあまりうまくいかず、「試しにIPv6だけが使える状態にならないか？」と「仮契約を止める」というのをやってみたところ、ISP契約がないフレッツひかり電話ってのは、IPv6オプションが自動的に外れるみたいで、IPv6網から外れてしまいました。　
* 慌てて、IPv6サービスを復活させるため再契約、IPv6の接続性は回復しましたが、IPv6-Prefixが別なものになってちょっとあたふた。
* NTT東フレッツの IPv6オプションだけ生かすことはできる？できない？という話になるかと思いますが、以下のような状況ではIPv6サービスはNGN網内で生き残ります。例えば、B-Fletsのような第一世代のIPv4/PPPoEサービスをそのままNGN移行した場合にはNGNでIPoE化契約を結べるようになってる場合があります。
* ある時期にNTTの光回線を再販業者に切り替えてしまった場合にはこの条件には当てはまらないようで、閉域のIPv6網につながりません。OCNでそんな回線移行をしたケースでIP交換機が間に入ってしまった電話共用回線では、IPv6の疎通すらできていないことがあります。

## IPv6は使えるけれど・・・

* IPv6の接続が回復したけれど、IPv4の設定はさっぱり・・・というのも、NTTのHGWでTransixのIPv4の端点は作れません。
* サポートに確認したのですが、HGWの下にIPv6-IPv4トンネルを掘るルータが必要(transix独自機構だから）
* 電話契約もあるからHGWをすっ飛ばすわけにはいきません。困った・・・
* とりあえず、IPv6のVPNだけは復活したので、IPv4の接続をwiregurd/NAPTですべて支店のIPv4に振ってみることにしました（ちょっと嫌だけど）とりあえず動いた。

## 真打登場・IIJ/SEILx86-ayame

* どうしたものか？　まあ、ルータを買えば済む話なんですが、技術的に全く無知だからと10GbEのスイッチとルータを買わせるのも癪です。
* すでにFreeBSDで、IPv6トンネルを作ろうかなーという気にはなっていますが、Transixはちょっと別物みたいだし、現状VPNが動かなくなるのも困る。
* [SEIL/x86 Ayame on FreeBSD bhyve](https://qiita.com/bsd-hacker/items/c19c39b022e1d5549624) の記事は随分前に読んでいたんですが、色々あって保留していました。これをちゃんと動かそうじゃないのーということになりました。

### SEILx86-ayame の最新版起動・・・


* bhyve の環境はとりあえず昔はよく使ってました・・今は面倒なのでJail一択ですけれど。
* 久しぶりにbhyveで忘れてることが多すぎた。
* NetBSD なので、古いブート方式だろーと思ってたらそうではありませんでした。
* 山本さんの記事から5年も経っていると、3.3で UEFIが普通になっていました。そうだよな。UEFI楽だものな。
* UEFIのGrubブートの手法ってのはあまり詳しくはなかったのですが、boot.log見て
grub.conf　直せば通るらしいことがわかってどうにか起動しました。

```
loader="uefi"
grub_run0="knetbsd -h -r ld0a (hd0,gpt1)/boot/efi/bootx86.efi"
```

* switch の設定が事前のOS側設定と合致していないとここでも引っかかりブートしません。起動させたいだけで、Switchの設定を後回しにするならコメントアウトしてしまうのがいいです。

### Bootした後

* 昔ながら vnc 使えって書いてあるんですが、普通にvm console hogehoge でもいけます。
* 5年も経てば改良されたところかもしれませんね・・・
* ブートすることを優先するとルータなのにNICが出てこない可能性があります・・・💦
* ルータとサーバが一緒になっていて、FreeBSD Jail(bastille)/VNET　環境であれば、共有するブリッジの問題を解決しましょう。
* bastille では最近のバージョンで、VNETでは、{NIC名}bridgeを使って物理NICー仮想NICのブリッジを構成します。

```bash
# vm switch list
NAME         TYPE      IFACE           ADDRESS  PRIVATE  MTU  VLAN  PORTS
vm-switch0   manual    ix1bridge       n/a      no       n/a  n/a   n/a
vm-switch-1  standard  vm-vm-switch-1  -        no       -    -     switch-1 em0

# ifconfig ix1bridge
ix1bridge: flags=1008843<UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST,LOWER_UP> metric 0 mtu 1500
　　　　flags=1008843<UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST,LOWER_UP> metric 0 mtu 1500
	options=0
	ether xx:yy:zz:pp:qq:rr
	id 00:00:00:00:00:00 priority 32768 hellotime 2 fwddelay 15
	maxage 20 holdcnt 6 proto rstp maxaddr 2000 timeout 1200
	root id 00:00:00:00:00:00 priority 32768 ifcost 0 port 0
	member: e0a_postfix flags=143<LEARNING,DISCOVER,AUTOEDGE,AUTOPTP>
	        ifmaxaddr 0 port 14 priority 128 path cost 2000
	member: tap0 flags=143<LEARNING,DISCOVER,AUTOEDGE,AUTOPTP>
	        ifmaxaddr 0 port 20 priority 128 path cost 2000000
	member: e0a_ymail flags=143<LEARNING,DISCOVER,AUTOEDGE,AUTOPTP>
	        ifmaxaddr 0 port 17 priority 128 path cost 2000
	member: ix1 flags=143<LEARNING,DISCOVER,AUTOEDGE,AUTOPTP>
	        ifmaxaddr 0 port 2 priority 128 path cost 2000
	groups: bridge
	nd6 options=9<PERFORMNUD,IFDISABLED>


```

といった感じになります. 
*　詳しくはこちらを参照。 [vm-bhyve test](https://github.com/hpaluch/freebsd-files/blob/master/VM-BHYVE.md)

## seilx86 を設定していく

* 昔のseilx86は実験的なところが多くNetBSDっぽいところをそのまま使えるような記事が多かったですが、もう商用の立派な
ルータなので "admin" で管理する提供携帯になっているようです。　BSDっぽく管理したいところもありますが、そこはそれ。
* とりあえず、console でログインできちゃうのですが、最初は「Adminのパスワードを設定しろ」といってきます。
* 以下はAdminのパスワードが設定された後のコンソール。

```
# vm console seilx86-ayame
Connected

login: admin
Password:
IIJ SEIL/x86 Ayame Ver. 3.33 (Release)
Warning! This system will be shut down in 88 days
```

* 仮運用のライセンスなので「88日後にシャットダウンされますよ」とでています。実際シャットダウンすると設定が消えるのでお試し版はそういう設定なのでしょう。ここも root アクセスできなくした理由かもしれませんが・・・
* bhyveの仮想コンソールは、面倒臭いところがあり チルダを数回打って抜ける仮想コンソール切断キーシーケンスを使うしか抜ける方法がなかったりします。また、これは ssh の端末切断のシーケンスと被るので、ssh でアクセスすると切れることがあります。なので、さっさとge0あたりにプライベートなIPv4を振って抜けた方が後が楽です。
* デフォルトでは、ipv4のSSH/telnetが使えるようになっていて、ipv6は使えなくなっています。　SEILx86の初期設定時、IPv4は固定の192.168.0.1/24 だったりするのでフィルタされていません。しかし、IPv6が使えるようになると大抵SLAACだったりDHCPv6なんかの割り当てが来た時点で対外的に繋がるためにあらかじめフィルタされているようです。　
* seilx86 の設定例は色々出ているのですが、[SEIL/x86 Ayameで10GbE対応ルータを構築する](https://eng-blog.iij.ad.jp/archives/29258) と、[https://www.seil.jp/sx4/doc/ug/internet/ipoe_transix-static_dual.html](https://www.seil.jp/sx4/doc/ug/internet/ipoe_transix-static_dual.html) を合わせて読んで設定が完了しました。
* こういう設定を作っていく場合は「わかっているところから設定して様子を見て変更していく」というやり方が私にはあっているようです。一気に理解して設定するというのが得意な天才の方もいらっしゃるかと思いますが・・・

1. まずIPv4接続ができるようにする。ssh で繋げるとTERM環境で色がついて良い。
2. IPv6が取れるようにする（設定例では、SLAACだったが、ひかり電話契約なのでDHCPv6設定）
3. リゾルバ設定して www.google.co.jp にping通るか試す。
4. 設定例に従い 4to6 IPIP トンネルを設定していく
5. DDNS設定（これがよくわかってない）と書かれているところは transix独自設定らしいのでとりあえず書く
6. NAPT 設定する[NAT](https://www.seil.jp/sx4/doc/sa/nat/example/nat.html)
7. filter設定していく（未着手）

* edit -> commit -> show log で設定を加えるたびに確認できるのが扱いやすいなと思ったところです。
* IPIP設定自体があまり例がないのですが、Seilx86の設定例が最もシンプルです。

## まとめ

* FreeBSD/seilx86-ayame を使えば、FreeBSDルータでもIPoE/IPIP のルータになります。
* フレッツ光クロスでの事例ですが、普通にフレッツ光でもできるなら試していこうかと思う次第。
* bhyveで、SeilX86-ayame を使うのは「公式に認められていない」ので、この記事を追試したいのであれば自己責任でお願いします。私が試した条件でIIJさんに問い合わせしないようにしてください。

以上
