---
title: OpenSMTPD
description: この文書は、qmail+vpopmail環境のシンプルさから脱却できないユーザへのOpenSMTPD移行のガイドです
date: 2026-01-06T09:01:01.000Z
draft: false
tags:
  - OpenSMTPD
  - vpopmail
  - FreeBSD
categories:
  - Technology
---
# OpenSMTPDによるメールサーバ構築ガイド

## 背景と選定理由

メール管理システムとして、qmail → postfix への移行を検討していましたが、細かい設定が必要なリレー部分だけをpostfixでカバーしてきました。長年qmailとvpopmailを使ってきた経験から、その使い勝手に慣れているケースも多いでしょう。

近年、postfixでの運用実績は増えていますが、dovecot+postfixのユーザ管理部分をどう実装するかが課題です。GUIツールは意外に完成度が低かったり、日本語対応が不十分だったりします。また、SQL認証に切り替えても、既存のvpopmailの設定をそのまま移行できないという難点がありました。

**qmail+vpopmailの問題点**：SMTP認証が使えないため、現代的な要件を満たせません。

**OpenSMTPDの利点**：qmailを使わず、セキュアで管理が楽なメールサーバとして、OpenSMTPDが最適です。設定も、postfixなら数日かかる作業が1時間程度で解決できるほどシンプルです。vpopmailはPOP3サーバの機能とフォルダ構成が使えればよいという方針で、opensmtpd+vpopmailという組み合わせでサーバを構築した事例を紹介します。

## セットアップ

### 初期設定（FreeBSD）

FreeBSD/portsからインストールできますが、初期設定が必要です。

```bash
# chown -R _smtpq:wheel /var/spool/smtpd/corrupt
# chown -R root:_smtpq /var/spool/smtpd/offline
# chown -R _smtpq:wheel /var/spool/smtpd/purge
# chown -R _smtpq:wheel /var/spool/smtpd/queue
# chown -R _smtpq:wheel /var/spool/smtpd/temporary
# chmod -R 770 /var/spool/smtpd/offline
# chmod -R 700 /var/spool/smtpd/purge
```

これらのコマンドは頻繁に実行するため、スクリプト化しておくことをお勧めします。

## 設定ファイル構成

OpenSMTPDの設定は以下のファイルで構成されます：

- `/usr/local/etc/mail/smtpd.conf` - メインの設定ファイル
- `/usr/local/etc/mail/domains` - バーチャルドメイン名テーブル
- `/usr/local/etc/mail/vusers` - バーチャルドメインのユーザテーブル
- `/usr/local/etc/mail/creds` - アカウント・ハッシュ化パスワードのテーブル

**postfixとの比較**：postfixは設定が複雑で管理しにくいのに対し、OpenSMTPDは非常にシンプルです。

## 設定例
### smtpd.conf
```conf
table aliases file:/etc/mail/aliases
pki mail.example.com cert "/usr/local/etc/letsencrypt/live/mail.example.com/fullchain.pem"
pki mail.example.com key "/usr/local/etc/letsencrypt/live/mail.example.com/privkey.pem"
table creds file:/usr/local/etc/mail/creds
table domains file:/usr/local/etc/mail/domains
table vusers file:/usr/local/etc/mail/vusers

listen on ::1
listen on :: tls pki mail.example.com
listen on :: port 587 tls-require pki mail.example.com auth <creds>
listen on 0.0.0.0 tls pki mail.example.com
listen on 0.0.0.0 port 587 tls-require pki mail.example.com auth <creds>

action "delivery" maildir "/usr/local/vpopmail/domains/%{rcpt.domain}/%{rcpt.user}/Maildir" virtual <vusers>
action "relay" relay host smtp://192.168.1.100:25

match for domain <domains> action "delivery"
match from local for any action "relay"
match auth from any for any action "relay" 
match from local for any action "relay"
```

- 設定ファイルの解説

OpenSMTPDの設定は、pf.conf（パケットフィルタ）に似た構造を持っています。

**構成要素**：
1. **定義部分**：`pki`、`table`で始まる定義群
2. **動作設定**：`listen`、`action`、`match`の順に並ぶ

**重要な注意点**：
- 定義が通っていない組み合わせは全てエラーになります
- 定義がない場合：「定義なしのエラー」
- 定義だけあって動作・選択が定義されていない場合：「無効エラー」
- 論理的な結合・流れに矛盾がある場合：起動できてもエラーになります

**よくあるエラー例**：
- `vusers`の設定で、バーチャルアドレスとリアルアカウントの組み合わせが正しく設定されていない場合、Invalidエラーが頻発します
- `relay`の設定がrejectになっていると、受信専用のメールサーバになります

- 'domains' の設定は、転送先ではなく必ずターミネートされるドメインだけを書くこと。
RCPT に現れる可能性があっても relay になる場合は書くとバーチャルにしろローカルにしろ、ファイル保存、パイプ処理に付されるされるドメインのみ書く。

* vpopmail バーチャルユーザ向けの設定が　action 節に書かれています。 postfixでも同じ様にできそうなんですが、OpenSMTPDの設定はシンプルで理解しやすかったです。

### creds

- このファイルは、認証情報が保存されています。
- 認証に使うメールアドレスとハッシュ化パスワードのTSVと呼べばいいでしょうか
- ハッシュ化パスワードが必要ですが、doveadm pw と　似たようなCLIがあります　
```bash
$ smtpctl encrypt [PASSWORD] 
```

### domains

シンプルな、「扱うバーチャルドメイン」を並べたもの

### vusers 

バーチャルメールアドレス　と　Unixアカウント（保存先フォルダの所有権など）
の設定を個別に行います。これも postfix に似たものがあります。
vpopmail ユーザを作って保管されていたので、設定しておきます。

```
foo@example.dom.tld   vpopmail
bar@example.dom.tld   vpopmail
```


## アーキテクチャの利点

受信専用メールサーバも構築可能ですが、SMTP認証を行わない設定も可能です。

**postfix+dovecotの課題**：
- SMTP認証のための「認証情報の共有」が単体で完結できない
- postfix+dovecotのSASL認証接続を定義して初めて実現できる構造的な脆弱性
- dovecotの管理が煩雑

**OpenSMTPDの優位性**：
- SMTP認証に必要な許認可情報が単体で完結
- vpopmailとは別にパスワードを設定する必要がありますが、SMTPとPOP3サーバを依存関係で結ぶよりも堅牢なシステムになります

## まとめ

OpenSMTPDは、シンプルな設定ファイルでセキュアなメールサーバを構築できる優れた選択肢です。postfixの複雑さに悩んでいる方や、qmailから移行を検討している方には特におすすめです。
